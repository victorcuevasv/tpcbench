FROM ubuntujava:dev

ARG UNAME=anyuser
ARG UID=1000
ARG GID=100

RUN groupadd -g $GID -o $UNAME
RUN useradd -m -u $UID -g $GID -o -s /bin/bash $UNAME

#Install less for the Presto cli pager and wget to download the presto cli.

RUN apt-get update && apt-get install -y \
    less wget

ARG APACHE_MIRROR=archive.apache.org
ARG PRESTO_MIRROR=repo1.maven.org
ARG MAVEN_VERSION=3.6.0
ARG PRESTO_VERSION=0.220

#Download and decompress Maven.

RUN wget -q -P /opt http://$APACHE_MIRROR/dist/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz && \
    tar xzf /opt/apache-maven-$MAVEN_VERSION-bin.tar.gz -C /opt && \
    rm -f /opt/apache-maven-$MAVEN_VERSION-bin.tar.gz

ENV PATH="${PATH}:/opt/apache-maven-$MAVEN_VERSION/bin"

#Download the Presto CLI jar.

RUN wget --no-check-certificate -q -P /opt \ 
    https://$PRESTO_MIRROR/maven2/com/facebook/presto/presto-cli/$PRESTO_VERSION/presto-cli-$PRESTO_VERSION-executable.jar && \
    mv /opt/presto-cli-$PRESTO_VERSION-executable.jar /opt/presto && \
    chmod +x /opt/presto 
    
#Download the Simba JDBC driver for Databricks.

RUN wget -q -P /opt https://$APACHE_MIRROR/simbadriver/SparkJDBC41.jar 

#Install the Simba JDBC driver jar with Maven.

RUN mvn install:install-file -Dfile=/opt/SparkJDBC41.jar -DgroupId=Spark -DartifactId=SparkJDBC41 -Dversion=2.6.3.1003 -Dpackaging=jar    

#Download the Maven dependencies.

USER $UNAME

ADD project/*.xml /home/$UNAME/

RUN mvn  -q dependency:go-offline -f /home/$UNAME/pom.xml && \
    rm -f /home/$UNAME/pom.xml
    
RUN mvn  -q dependency:go-offline -f /home/$UNAME/pomSpark.xml && \
    rm -f /home/$UNAME/pomSpark.xml
    
RUN mvn  -q dependency:go-offline -f /home/$UNAME/pomSparkJDBC.xml && \
    rm -f /home/$UNAME/pomSparkJDBC.xml

CMD ["bash"]


