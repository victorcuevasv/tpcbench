FROM ubuntujava:dev

ARG UNAME=anyuser
ARG UID=1000
ARG GID=100

RUN groupadd -g $GID -o $UNAME
RUN useradd -m -u $UID -g $GID -o -s /bin/bash $UNAME

#Install less for the Presto cli pager.

RUN apt-get update && apt-get install -y \
    less

ARG APACHE_MIRROR=apache.rediris.es
ARG PRESTO_MIRROR=repo1.maven.org

#Download and decompress Maven.

RUN wget -q -P /opt http://$APACHE_MIRROR/maven/maven-3/3.6.0/binaries/apache-maven-3.6.0-bin.tar.gz && \
    tar xzf /opt/apache-maven-3.6.0-bin.tar.gz -C /opt && \
    rm -f /opt/apache-maven-3.6.0-bin.tar.gz

ENV PATH="${PATH}:/opt/apache-maven-3.6.0/bin"

#Download the Presto CLI jar.

RUN wget --no-check-certificate -q -P /opt \ 
    https://$PRESTO_MIRROR/maven2/com/facebook/presto/presto-cli/0.214/presto-cli-0.214-executable.jar && \
    mv /opt/presto-cli-0.214-executable.jar /opt/presto && \
    chmod +x /opt/presto 

#Download the Maven dependencies.

USER $UNAME

ADD project/*.xml /home/$UNAME/

RUN mvn  dependency:go-offline -f /home/$UNAME/pom.xml && \
    rm -f /home/$UNAME/pom.xml
    
RUN mvn  dependency:go-offline -f /home/$UNAME/pomSpark.xml && \
    rm -f /home/$UNAME/pomSpark.xml
    
RUN mvn  dependency:go-offline -f /home/$UNAME/pomSparkJDBC.xml && \
    rm -f /home/$UNAME/pomSparkJDBC.xml

CMD ["bash"]


