FROM ubuntujava:dev

USER root

ARG APACHE_MIRROR=apache.rediris.es
ARG POSTGRES_DRIVER_MIRROR=jdbc.postgresql.org
ARG PRESTO_MIRROR=repo1.maven.org

#Install netcat to use nc to check connections, ssh and python.

RUN apt-get update && apt-get install -y \
    netcat \
    ssh \
    python2.7 \
    python-pip \
    python-dev

#Add the generated key to the authorized set.

COPY ssh /root/.ssh

RUN chmod 600 /root/.ssh/id_rsa

RUN cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    
#The configuration file will enable passwordless login to nodes
#and without confirmation prompt.
    
COPY ssh_config /root/.ssh/config

#Download and decompress Hadoop

RUN wget -q -P /opt http://$APACHE_MIRROR/hadoop/common/hadoop-2.7.7/hadoop-2.7.7.tar.gz && \
    tar xzf /opt/hadoop-2.7.7.tar.gz -C /opt && \
    rm -f /opt/hadoop-2.7.7.tar.gz

#Add the Hadoop installation directory variable and update the path.

ENV HADOOP_HOME /opt/hadoop-2.7.7
ENV PATH="${PATH}:/opt/hadoop-2.7.7/bin:/opt/hadoop-2.7.7/sbin"

#Copy the Hadoop configuration files.

COPY etc_hadoop/* /opt/hadoop-2.7.7/etc/hadoop/

#Change the owner of the Hadoop files.

RUN useradd hadoop && \
    chown -R hadoop:hadoop /opt/hadoop-2.7.7

#Download and decompress Presto.

RUN wget --no-check-certificate -q -P /opt \
    https://$PRESTO_MIRROR/maven2/com/facebook/presto/presto-server/0.214/presto-server-0.214.tar.gz && \
    tar xzf /opt/presto-server-0.214.tar.gz -C /opt && \
    rm -f /opt/presto-server-0.214.tar.gz
    
#Copy the Presto configuration files.

COPY presto_etc_worker/etc/ /opt/presto-server-0.214/etc/

#Copy the initialization script for Hadoop, Hive, Presto and make it executable.

COPY startSlavePresto.sh /startSlavePresto.sh

RUN chmod +x /startSlavePresto.sh

CMD ["bash"]

ENTRYPOINT [ "bash", "-c", "/startSlavePresto.sh" ]

