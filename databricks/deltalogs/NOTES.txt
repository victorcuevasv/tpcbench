
CREATE TABLE filelog(
	experiment varchar(200),
	step int,
	operation varchar(20),
	path varchar(500),
	records int,
	size bigint,
	partition int
);

CREATE TABLE filecommits(
	experiment varchar(200),
	state int,
	path varchar(500),
	records int,
	size bigint,
	partition int
);

COPY filelog
FROM 'C:\Users\bscuser\Desktop\log.csv'
DELIMITER '|'
CSV HEADER;

INSERT INTO filecommits
SELECT experiment, 0, path, records, size, partition
FROM filelog WHERE step = 0 and operation = 'add';

do $$
declare
	i int := 0;
	maxCommit int := 5;
	stmt text;
begin
	loop
		exit when i = maxCommit; 
		stmt = FORMAT('INSERT INTO filecommits
		(SELECT experiment, %2$s, path, records, size, partition
		FROM filecommits
		WHERE state = %1$s AND 
			NOT EXISTS (SELECT *
						  FROM filelog
						  WHERE step = %2$s
						  AND operation = ''remove''
						  AND filelog.path = filecommits.path))
		UNION
		(SELECT experiment, %2$s, path, records, size, partition
		FROM filelog WHERE step = %2$s AND operation = ''add'')', i, i+1);
		EXECUTE stmt;
		RAISE NOTICE '%' , stmt;
		i := i + 1;
	end loop;	
end; $$

SELECT state, count(*), sum(records), sum(size)/(1024*1024), count(distinct partition) 
FROM filecommits
GROUP BY state


